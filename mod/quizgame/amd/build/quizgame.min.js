define(["jquery","core/yui","core/notification","core/ajax"],function(a,b,c,d){function e(a){if(document.getElementById("mod_quizgame_sound_on").checked){var b=document.getElementById("mod_quizgame_sound_"+a);b.currentTime=0,b.play()}}function f(){wa=!1,ca.removeAttribute("width"),ca.removeAttribute("height"),ca.removeAttribute("style"),ca.classList.remove("floating-game-canvas"),a("#button_container").removeClass("floating-button-container fixed-bottom"),pa.width=ca.clientWidth,pa.height=ca.clientHeight,ca.style.width=pa.width,ca.style.height=pa.height,i(ca)}function g(){wa&&f()}function h(){var b=window.matchMedia("(orientation: landscape)").matches;ca.requestFullscreen?ca.requestFullscreen():ca.msRequestFullscreen?ca.msRequestFullscreen():ca.mozRequestFullScreen&&ca.mozRequestFullScreen(),wa=!0;var c=a("#button_container"),d=window.innerWidth,e=a(window).height();b&&d<e&&(e=[d,d=e][0]),e-=c.height()+16,pa.width=d,pa.height=e,ca.style.width=d+"px",ca.style.height=e+"px",ca.classList.add("floating-game-canvas"),c.addClass("floating-button-container fixed-bottom"),a("#mod_quizgame_fullscreen_button").blur(),i(ca)}function i(a){a.width=pa.width,a.height=pa.height,ha.imageSmoothingEnabled=!1}function j(){wa?h():f()}function k(){document.onkeydown=null,document.onkeyup=null,document.onmousedown=null,document.onmouseup=null,document.onmousemove=null,document.ontouchstart=null,document.ontouchend=null,document.ontouchmove=null,window.onresize=null}function l(){k(),document.onkeydown=O,document.onmouseup=P,document.ontouchend=Q,window.onresize=j}function m(){ha.clearRect(0,0,pa.width,pa.height),ha.fillStyle="#FFFFFF",ha.font="18px Audiowide",ha.textAlign="center",null!==aa&&aa.length>0?(ha.fillText(M.util.get_string("spacetostart","mod_quizgame"),pa.width/2,pa.height/2),l()):ha.fillText(M.util.get_string("emptyquiz","mod_quizgame"),pa.width/2,pa.height/2)}function n(){$(aa),na?q():(la.forEach(function(a){var b=new Image;b.src=a,b.onload=function(){ma++,ma>=la.length&&p()}}),na=!0)}function o(){d.call([{methodname:"mod_quizgame_update_score",args:{quizgameid:ba,score:Math.trunc(ia)},fail:c.exception}]),l()}function p(){clearInterval(fa),fa=setInterval(function(){t(ha,pa,ka,ja,qa),u(pa,ka,ja)},40),q()}function q(){ia=0,ka=[],ja=[],oa=-1,ga=.5,ra=!1,sa=!1,d.call([{methodname:"mod_quizgame_start_game",args:{quizgameid:ba},fail:c.exception}]),da=new x("pix/ship.png",0,0),da.x=pa.width/2,da.y=pa.height/2,ka.push(da),ea=new y("pix/planet.png",0,0),ea.image.width=pa.width,ea.image.height=pa.height,ea.direction.y=1,ea.movespeed.y=.7,ja.push(ea),r(),document.onkeyup=S,document.onkeydown=R,document.onmouseup=U,document.onmousedown=T,document.onmousemove=V,document.ontouchstart=X,document.ontouchend=Y,document.ontouchmove=Z,window.onresize=j,document.addEventListener("gesturestart",W,!1),document.addEventListener("gesturechange",W,!1),document.addEventListener("gestureend",W,!1)}function r(){oa++,oa>=aa.length&&(oa=0,ga*=1.3),qa=s(aa,oa,pa)}function s(a,b,c){if(ta=[],ua=0,va=0,"truefalse"==a[b].type)a[b].answers.forEach(function(a){var b=new B(Math.random()*c.width,-Math.random()*c.height/2,a.text,a.fraction);ta.push(b),ka.push(b)}),va=0;else if("multichoice"==a[b].type)a[b].answers.forEach(function(d){var e=new C(Math.random()*c.width,-Math.random()*c.height/2,d.text,d.fraction,a[b].single);d.fraction<1&&(ta.push(e),d.fraction>0&&(va+=parseFloat(d.fraction))),ka.push(e)});else if("match"==a[b].type){var d=0,e=1/(2*a[b].stems.length);va+=1,a[b].stems.forEach(function(a){d++;var b=new D(Math.random()*c.width,-Math.random()*c.height/2,a.question,e,(-d),(!0)),f=new D(Math.random()*c.width,-Math.random()*c.height/2,a.answer,e,d);ta.push(b),ta.push(f),ka.push(b),ka.push(f)})}return a[b].question}function t(a,b,c,d,e){a.clearRect(0,0,b.width,b.height);for(var f=0;f<d.length;f++)d[f].draw(a);for(f=0;f<c.length;f++)c[f].draw(a);da.alive?(a.fillStyle="#FFFFFF",a.font="18px Audiowide",a.textAlign="left",a.fillText(M.util.get_string("score","mod_quizgame",{score:Math.round(ia),lives:da.lives}),5,b.height-20),a.textAlign="center",L(a,e,!1,20,.9*b.width,b.width/2,20)):(a.fillStyle="#FFFFFF",a.font="18px Audiowide",a.textAlign="center",a.fillText(M.util.get_string("endofgame","mod_quizgame",Math.round(da.lastScore)),b.width/2,b.height/2))}function u(a,b,c){for(var d=0;d<3;d++)c.push(new G(a));for(d=0;d<c.length;d++)c[d].update(a),c[d].alive||(c.splice(d,1),d--);for(d=0;d<b.length;d++){b[d].update(a);for(var e=d+1;e<b.length;e++)H(b[d],b[e]);b[d].alive||(b.splice(d,1),d--)}}function v(a,b,c,d){this.left=a||0,this.top=b||0,this.width=c||0,this.height=d||0}function w(a,b,c){null!==a&&(this.image=this.loadImage(a)),this.x=b,this.y=c,this.velocity={x:0,y:0},this.direction={x:0,y:0},this.movespeed={x:5,y:3},this.alive=!0,this.decay=.7}function x(a,b,c){w.call(this,a,b,c),this.mouse={x:0,y:0},this.movespeed={x:6,y:4},this.lives=3,this.lastScore=0}function y(a,b,c){w.call(this,a,b,c)}function z(a,b,c,d,e){w.call(this,a,b,c),this.xspeed=ga,this.yspeed=ga*(2+Math.random())/4,this.movespeed.x=0,this.movespeed.y=0,this.direction.y=1,this.text=d,this.fraction=e,this.movementClock=0,this.shotFrequency=80,this.shotClock=(1+Math.random())*this.shotFrequency,this.level=oa}function A(){ta.forEach(function(a){a.alive&&(a.fraction=0,a.die())}),ta=[]}function B(a,b,c,d){z.call(this,"pix/enemy.png",a,b,c,d)}function C(a,b,c,d,e){z.call(this,"pix/enemy.png",a,b,c,d),this.single=e}function D(a,b,c,d,e,f){this.stem=!!f,this.stem?z.call(this,"pix/enemystem.png",a,b,c,d):z.call(this,"pix/enemychoice.png",a,b,c,d),this.pairid=e,this.shotFrequency=160,this.hightlighted=!1}function E(a,b,c,d){w.call(this,c?"pix/laser.png":"pix/enemylaser.png",a,b),this.direction.y=-1,this.friendly=c?1:0,this.laserSpeed=d||12}function F(a,b,c,d){w.call(this,null,a,b),this.width=2,this.height=2,this.velocity.x=c.x,this.velocity.y=c.y,this.aliveTime=0,this.colour=d,this.decay=1}function G(a){w.call(this,null,Math.random()*a.width,0),this.width=2,this.height=2,this.direction.y=1,this.movespeed.y=.2+Math.random()/2,this.aliveTime=0}function H(a,b){return a.alive&&b.alive&&(I(a,b)||I(b,a))}function I(a,b){return a instanceof E&&b instanceof x&&!a.friendly&&J(a,b)?(b.gotShot(a),a.die(),!0):a instanceof E&&b instanceof z&&a.friendly&&J(a,b)?(b.gotShot(a),!0):a instanceof x&&b instanceof z&&J(a,b)?(a.die(),!0):void 0}function J(a,b){var c=a.getRect(),d=b.getRect();return c.Intersect(d)}function K(a,b,c,d){for(var e=0;e<c;e++)ja.push(new F(a,b,{x:16*(Math.random()-.5),y:16*(Math.random()-.5)+3},d))}function L(a,b,c,d,e,f,g){var h=[],i=g,j=b.split(" "),k="";j.forEach(function(b){var c=k+" "+b,f=a.measureText(c),i=f.width;i>e?(h.push({text:k,y:g+=d}),k=b):k=c}),h.push({text:k,y:g+=d});var l=g-i;h.forEach(function(b){var d=c?-l:0;a.fillText(b.text,f,b.y+d)})}function N(){var a=ta.filter(function(a){return a.alive}).length;0===a&&(va<this.fraction||va<=0)&&this.level===oa&&da.alive&&r()}function O(a){[32,37,38,39,40].indexOf(a.keyCode)!==-1&&(a.preventDefault(),32===a.keyCode&&n())}function P(a){a.target===ca&&n()}function Q(a){a.target===ca&&n()}function R(a){[32,37,38,39,40].indexOf(a.keyCode)!==-1&&(a.preventDefault(),32===a.keyCode&&da.alive&&xa?da.Shoot():37===a.keyCode?da.direction.x=-1:38===a.keyCode?da.direction.y=-1:39===a.keyCode?da.direction.x=1:40===a.keyCode&&(da.direction.y=1))}function S(a){32===a.keyCode?xa=!0:[37,39].indexOf(a.keyCode)!==-1?da.direction.x=0:[38,40].indexOf(a.keyCode)!==-1&&(da.direction.y=0)}function T(a){if(a.target===ca){var b=da.getRect().Contains({x:a.offsetX,y:a.offsetY});b&&da.alive&&da.Shoot(),sa||(da.mouse.x=a.offsetX,da.mouse.y=a.offsetY,sa=!0)}}function U(){da.direction.x=0,da.direction.y=0,sa=!1}function V(a){da.mouse.x=a.offsetX,da.mouse.y=a.offsetY}function W(a){a.target===ca&&a.preventDefault()}function X(a){a.target===ca&&(da.alive&&a.touches.length>1?da.Shoot():(ra=!0,Z(a)),a.preventDefault())}function Y(a){0===a.touches.length&&(ra=!1),da.direction.x=0,da.direction.y=0,a.target===ca&&a.preventDefault()}function Z(a){var b=a.target.getBoundingClientRect(),c=a.touches[0].pageX-b.left,d=a.touches[0].clientY-b.top;window.stage=ca,da.mouse.x=c,da.mouse.y=d,a.target===ca&&a.preventDefault()}function $(a){for(var b,c,d=a.length;0!==d;)c=Math.floor(Math.random()*d),d-=1,b=a[d],a[d]=a[c],a[c]=b;return a}function _(a,b){aa=a,ba=b,document.addEventListener&&(document.addEventListener("fullscreenchange",g,!1),document.addEventListener("MSFullscreenChange",g,!1),document.addEventListener("mozfullscreenchange",g,!1),document.addEventListener("webkitfullscreenchange",g,!1)),ca=document.getElementById("mod_quizgame_game"),ha=ca.getContext("2d"),f(),fa=setInterval(function(){m()},500)}var aa,ba,ca,da,ea,fa,ga,ha,ia=0,ja=[],ka=[],la=["pix/icon.gif","pix/planet.png","pix/ship.png","pix/enemy.png","pix/enemystem.png","pix/enemychoice.png","pix/enemystemselected.png","pix/enemychoiceselected.png","pix/laser.png","pix/enemylaser.png"],ma=0,na=!1,oa=-1,pa={x:0,y:0,width:0,height:0},qa="",ra=!1,sa=!1,ta=[],ua=0,va=0,wa=!1;a("#mod_quizgame_fullscreen_button").on("click",function(){wa?(wa=!1,f()):h()}),v.prototype.right=function(){return this.left+this.width},v.prototype.bottom=function(){return this.top+this.height},v.prototype.Contains=function(a){return a.x>this.left&&a.x<this.right()&&a.y>this.top&&a.y<this.bottom()},v.prototype.Intersect=function(a){var b=!(a.left>this.right()||a.right()<this.left||a.top>this.bottom()||a.bottom()<this.top);return b},w.prototype.loadImage=function(a){return this.image||(this.image=new Image),this.image.src=a,this.image},w.prototype.update=function(){this.velocity.x+=this.direction.x*this.movespeed.x,this.velocity.y+=this.direction.y*this.movespeed.y,this.x+=this.velocity.x,this.y+=this.velocity.y,this.velocity.y*=this.decay,this.velocity.x*=this.decay},w.prototype.draw=function(a){a.drawImage(this.image,this.x,this.y,this.image.width,this.image.height)},w.prototype.getRect=function(){return new v(this.x,this.y,this.image.width,this.image.height)},w.prototype.die=function(){this.alive=!1},x.prototype=Object.create(w.prototype),x.prototype.update=function(a){(sa||ra)&&(this.x<this.mouse.x-this.image.width?da.direction.x=1:this.x>this.mouse.x?da.direction.x=-1:da.direction.x=0,this.y<this.mouse.y-this.image.height?da.direction.y=1:this.y>this.mouse.y?da.direction.y=-1:da.direction.y=0),w.prototype.update.call(this,a),this.x<a.x-this.image.width?this.x=a.width:this.x>a.width&&(this.x=a.x-this.image.width),this.y<a.y?this.y=a.y:this.y>a.height-this.image.height&&(this.y=a.height-this.image.height)},x.prototype.Shoot=function(){e("laser"),ka.unshift(new E(da.x,da.y,(!0),24)),xa=!1},x.prototype.die=function(){w.prototype.die.call(this),e("explosion"),K(this.x+this.image.width/2,this.y+this.image.height/2,200,"#FFCC00"),this.lastScore=ia,o()},x.prototype.gotShot=function(a){a.alive&&(this.lives<=1?this.die():(this.lives--,K(this.x+this.image.width/2,this.y+this.image.height/2,100,"#FFCC00")))},y.prototype=Object.create(w.prototype),y.prototype.update=function(a){ea.image.width=pa.width,ea.image.height=pa.height,w.prototype.update.call(this,a)},z.prototype=Object.create(w.prototype),z.prototype.update=function(a){if(this.y<a.height/10||this.y>9*a.height/10?(this.movespeed.x=1*this.xspeed,this.movespeed.y=5*this.yspeed):(this.movespeed.x=this.xspeed,this.movespeed.y=this.yspeed),w.prototype.update.call(this,a),this.movementClock--,this.movementClock<=0&&(this.direction.x=Math.floor(3*Math.random())-1,this.movementClock=30*(2+Math.random())),this.shotClock-=ga,this.shotClock<=0&&this.y<.6*a.height){e("enemylaser");var b=new E(this.x,this.y);b.direction.y=1,b.friendly=!1,ka.unshift(b),this.shotClock=(1+Math.random())*this.shotFrequency}this.x<a.x-this.image.width?this.x=a.width:this.x>a.width&&(this.x=a.x-this.image.width),this.y>a.height+this.image.height&&this.alive&&(this.alive=!1,this.fraction>0&&(va-=this.fraction,ia-=1e3*this.fraction),N.call(this))},z.prototype.draw=function(a){w.prototype.draw.call(this,a),a.fillStyle="#FFFFFF",a.font="15px Audiowide",a.textAlign="center",L(a,this.text,!0,17,.2*pa.width,this.x+this.image.width/2,this.y-5)},z.prototype.die=function(){w.prototype.die.call(this),K(this.x+this.image.width,this.y+this.image.height,50+150*this.fraction,"#FF0000"),ia+=1e3*this.fraction,e("explosion")},z.prototype.gotShot=function(a){a.die(),this.die()},B.prototype=Object.create(z.prototype),B.prototype.die=function(){z.prototype.die.call(this),A(),this.fraction>0&&r()},B.prototype.gotShot=function(a){this.fraction>0?(a.die(),this.die()):(ia+=600*(this.fraction-.5),a.deflect())},C.prototype=Object.create(z.prototype),C.prototype.die=function(){z.prototype.die.call(this),this.fraction>0&&(va-=this.fraction),(this.single&&1===this.fraction&&this.fraction>=1||this.fraction>0&&va<=0)&&(A(),r())},C.prototype.gotShot=function(a){this.fraction>=1||this.fraction>0&&!this.single?(a.die(),this.die()):(ia+=600*(this.fraction-.5),a.deflect())},D.prototype=Object.create(z.prototype),D.prototype.die=function(){va-=this.fraction,this.fraction=0,z.prototype.die.call(this)},D.prototype.gotShot=function(a){if(a.alive&&this.alive)if(ua==-this.pairid){ia+=1e3*this.fraction*2,a.die(),this.die();var b=0;ta.forEach(function(a){a.pairid==ua&&a.die(),a.alive&&b++}),b<=0&&r()}else ua==this.pairid?a.deflect():(a.die(),this.hightlight(),ua=this.pairid)},D.prototype.hightlight=function(){ta.forEach(function(a){a.unhightlight()}),this.stem?this.loadImage("pix/enemystemselected.png"):this.loadImage("pix/enemychoiceselected.png"),this.hightlighted=!0},D.prototype.unhightlight=function(){this.hightlighted&&(this.stem?this.loadImage("pix/enemystem.png"):this.loadImage("pix/enemychoice.png")),this.hightlighted=!1},E.prototype=Object.create(w.prototype),E.prototype.update=function(a){w.prototype.update.call(this,a),(this.x<a.x-this.image.width||this.x>a.width||this.y<a.y-this.image.height||this.y>a.height)&&(this.alive=!1),this.velocity.y=this.laserSpeed*this.direction.y},E.prototype.deflect=function(){this.image=this.loadImage("pix/enemylaser.png"),this.direction.y*=-1,this.friendly=!this.friendly,e("deflect")},F.prototype=Object.create(w.prototype),F.prototype.update=function(a){w.prototype.update.call(this,a),(this.x<a.x-this.width||this.x>a.width||this.y<a.y-this.height||this.y>a.height)&&(this.alive=!1),this.aliveTime++,this.aliveTime>15*Math.random()+5&&(this.alive=!1)},F.prototype.getRect=function(){return new v(this.x,this.y,this.width,this.height)},F.prototype.draw=function(a){a.fillStyle=this.colour,a.fillRect(this.x,this.y,this.width,this.height),a.stroke()},G.prototype=Object.create(w.prototype),G.prototype.update=function(a){w.prototype.update.call(this,a),this.y>a.height&&(this.alive=!1)},G.prototype.draw=function(a){a.fillStyle="#9999AA",a.fillRect(this.x,this.y,this.width,this.height),a.stroke()};var xa=!0;return{init:_}});